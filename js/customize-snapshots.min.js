var customizeSnapshots=function(a){var b,c,d={},e=wp.customize,f=_customizeSnapshots.uuid,g=_customizeSnapshots.is_preview,h=_customizeSnapshots.snapshot_theme;d.init=function(){window._wpCustomizeControlsL10n.save=_customizeSnapshots.i18n.publish,window._wpCustomizeControlsL10n.saved=_customizeSnapshots.i18n.published,e.bind("ready",function(){!e.settings.theme.active||h&&h!==e.settings.theme.stylesheet||(d.previewerQuery(),d.addButton(),d.addDialogForm(),d.dialogEvents(),g&&e.state("saved").set(!1))}),e.bind("save",function(b){return b.fail(function(b){var c="snapshot-dialog-error",d=wp.template(c);b.responseText&&(0===a("#"+c).length&&a("body").append(d({title:_customizeSnapshots.i18n.publish,message:_customizeSnapshots.i18n.permsMsg})),a("#customize-header-actions .spinner").removeClass("is-active"),a("#"+c).dialog({autoOpen:!0,modal:!0}))}),b})},d.previewerQuery=function(){var a=e.previewer.query;e.previewer.query=function(){var b,c=this,d={};return b=a.apply(c,arguments),g&&(e.each(function(a,b){d[b]={value:a(),dirty:!1}}),b.snapshot_customized=JSON.stringify(d),b.snapshot_uuid=f),b}},d.addButton=function(){var b,c,d=a("#customize-header-actions");d.length&&0===d.find("#snapshot-save").length&&(b=wp.template("snapshot-save"),c={buttonText:_customizeSnapshots.i18n.saveButton},a(b(c)).insertAfter(d.find("#save")))},d.addDialogForm=function(){var b=wp.template("snapshot-dialog-form"),c={title:_customizeSnapshots.i18n.formTitle,is_preview:g,message:_customizeSnapshots.i18n.saveMsg,scope:_customizeSnapshots.scope,scopeTitle:_customizeSnapshots.i18n.scopeTitle,dirtyLabel:_customizeSnapshots.i18n.dirtyLabel,fullLabel:_customizeSnapshots.i18n.fullLabel};a("body").append(b(c))},d.dialogEvents=function(){b=a("#snapshot-dialog-form").dialog({autoOpen:!1,modal:!0,buttons:{Save:{text:_customizeSnapshots.i18n.saveButton,click:d.sendUpdateSnapshotRequest},Cancel:{text:_customizeSnapshots.i18n.cancelButton,click:function(){b.dialog("close")}}},close:function(){c[0].reset()}}),c=b.find("form").on("submit",function(a){a.preventDefault(),b.next(".ui-dialog-buttonpane").find("button:first-child").disabled(!0),d.sendUpdateSnapshotRequest()}),a("#snapshot-save").on("click",function(a){a.preventDefault(),b.dialog("open"),b.find("form input[name=scope]").blur(),b.next(".ui-dialog-buttonpane").find("button").blur()})},d.sendUpdateSnapshotRequest=function(){var c,d,h=a("#customize-header-actions .spinner"),i=b.find('form input[name="scope"]:checked').val();i||(i=b.find('form input[type="hidden"]').val()),b.dialog("close"),h.addClass("is-active"),d={},e.each(function(a,b){d[b]={value:a(),dirty:a._dirty}}),c=wp.ajax.post("customize_update_snapshot",{nonce:_customizeSnapshots.nonce,wp_customize:"on",snapshot_customized:JSON.stringify(d),customize_snapshot_uuid:f,scope:i,preview:g?"on":"off"}),c.done(function(b){var c=wp.customize.previewer.previewUrl(),d=new RegExp("([?&])customize_snapshot_uuid=.*?(&|$)","i"),e=-1!==c.indexOf("?")?"&":"?",j="snapshot-dialog-link",k=wp.template(j);c=c.match(d)?c.replace(d,"$1customize_snapshot_uuid="+b.customize_snapshot_uuid+"$2"):c+e+"customize_snapshot_uuid="+b.customize_snapshot_uuid,"dirty"!==i&&(i="full"),c+="&scope="+i,g||(f=b.customize_snapshot_next_uuid),a("#"+j).length&&a("#"+j).remove(),a("body").append(k({title:_customizeSnapshots.i18n.previewTitle,url:c})),h.removeClass("is-active"),a("#"+j).dialog({autoOpen:!0,modal:!0}),a("#"+j).find("a").blur()}),c.fail(function(){var b="snapshot-dialog-error",c=wp.template(b);0===a("#"+b).length&&a("body").append(c({title:_customizeSnapshots.i18n.formTitle,message:_customizeSnapshots.i18n.errorMsg})),h.removeClass("is-active"),a("#"+b).dialog({autoOpen:!0,modal:!0})})},d.init()}(jQuery);
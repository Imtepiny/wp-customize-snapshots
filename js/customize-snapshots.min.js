!function(a,b){"use strict";var c;a.Snapshots||(a.Snapshots={}),c=a.Snapshots,c.data={},"undefined"!=typeof _customizeSnapshots&&_.extend(c.data,_customizeSnapshots),c.init=function(){window._wpCustomizeControlsL10n.save=c.data.i18n.publish,window._wpCustomizeControlsL10n.saved=c.data.i18n.published,a.bind("ready",function(){!a.settings.theme.active||c.data.theme&&c.data.theme!==a.settings.theme.stylesheet||(a.state.create("snapshot-saved",!0),a.state.create("snapshot-submitted",!0),a.bind("change",function(){a.state("snapshot-saved").set(!1),a.state("snapshot-submitted").set(!1)}),c.previewerQuery(),c.addButtons(),b("#snapshot-save").on("click",function(a){a.preventDefault(),c.sendUpdateSnapshotRequest({status:"draft",openNewWindow:a.shiftKey})}),b("#snapshot-submit").on("click",function(a){a.preventDefault(),c.sendUpdateSnapshotRequest({status:"pending",openNewWindow:a.shiftKey})}),c.data.isPreview&&(a.state("saved").set(!1),c.resetSavedStateQuietly()))}),a.bind("save",function(d){return a.state("saved").set(!1),d.fail(function(a){var d="snapshot-dialog-error",e=wp.template(d);a.responseText&&(0===b("#"+d).length&&b("body").append(e({title:c.data.i18n.publish,message:c.data.isPreview?c.data.i18n.permsMsg.update:c.data.i18n.permsMsg.save})),b("#customize-header-actions .spinner").removeClass("is-active"),b("#"+d).dialog({autoOpen:!0,modal:!0}))}),d}),a.bind("saved",function(){var a,b,d,e=window.location.href;c.changeButton(c.data.i18n.saveButton,c.data.i18n.permsMsg.save),a=wp.ajax.post("customize_get_snapshot_uuid",{nonce:c.data.nonce,wp_customize:"on"}),a.done(function(a){c.data.uuid=a.uuid}),d=e.split("?"),history.replaceState&&d[1]&&(b=d[0]+"?"+_.filter(d[1].split("&"),function(a){return!/^(customize_snapshot_uuid)=/.test(a)}).join("&"),b=b.replace(/\?$/,""),b!==e&&history.replaceState({},document.title,b))})},c.previewerQuery=function(){var b=a.previewer.query;a.previewer.query=function(){var d,e={};return d=b.apply(this,arguments),c.data.isPreview&&(a.each(function(a,b){e[b]={value:a(),dirty:a._dirty}}),d.snapshot_customized=JSON.stringify(e),d.snapshot_uuid=c.data.uuid),d}},c.addButtons=function(){var d,e,f,g=b("#customize-header-actions"),h=g.find("#save");d=wp.template("snapshot-save"),f={buttonText:c.data.isPreview?c.data.i18n.updateButton:c.data.i18n.saveButton},d=b(b.trim(d(f))),c.data.currentUserCanPublish||d.attr("title",c.data.isPreview?c.data.i18n.permsMsg.update:c.data.i18n.permsMsg.save),d.prop("disabled",!0),d.insertAfter(h),a.state("snapshot-saved").bind(function(a){d.prop("disabled",a)}),c.data.currentUserCanPublish||(h.hide(),e=wp.template("snapshot-submit"),e=b(b.trim(e({buttonText:c.data.i18n.submit}))),e.prop("disabled",!0),e.insertBefore(d),a.state("snapshot-submitted").bind(function(a){e.prop("disabled",a)})),g.addClass("button-added")},c.changeButton=function(a,d){var e=b("#customize-header-actions").find("#snapshot-save");e.length&&(e.text(a),c.data.currentUserCanPublish||e.attr("title",d))},c.resetSavedStateQuietly=function(){a.state("saved")._value=!0},c.sendUpdateSnapshotRequest=function(d){var e,f,g,h=b("#customize-header-actions .spinner");g=_.extend({status:"draft",openNewWindow:!1},d),h.addClass("is-active"),f={},a.each(function(a,b){f[b]={value:a(),dirty:a._dirty}}),e=wp.ajax.post("customize_update_snapshot",{nonce:c.data.nonce,wp_customize:"on",snapshot_customized:JSON.stringify(f),customize_snapshot_uuid:c.data.uuid,status:g.status,preview:c.data.isPreview?"on":"off"}),e.done(function(b){var d=a.previewer.previewUrl(),e=new RegExp("([?&])customize_snapshot_uuid=.*?(&|$)","i"),f=-1!==d.indexOf("?")?"&":"?",i=window.location.href,j=-1!==i.indexOf("?")?"&":"?";c.data.uuid||(c.data.uuid=b.customize_snapshot_uuid),d=d.match(e)?d.replace(e,"$1customize_snapshot_uuid="+encodeURIComponent(c.data.uuid)+"$2"):d+f+"customize_snapshot_uuid="+encodeURIComponent(c.data.uuid),c.changeButton(c.data.i18n.updateButton,c.data.i18n.permsMsg.update),c.data.isPreview=!0,h.removeClass("is-active"),c.resetSavedStateQuietly(),history.replaceState&&!i.match(e)&&(i+=j+"customize_snapshot_uuid="+encodeURIComponent(c.data.uuid),history.replaceState({},document.title,i)),a.state("snapshot-saved").set(!0),"pending"===g.status&&a.state("snapshot-submitted").set(!0),g.openNewWindow&&window.open(d,"_blank"),a.trigger("customize-snapshots-update",{previewUrl:d,customizeUrl:i,uuid:c.data.uuid})}),e.fail(function(){var a="snapshot-dialog-error",d=wp.template(a);0===b("#"+a).length&&b("body").append(d({title:c.data.i18n.errorTitle,message:c.data.i18n.errorMsg})),b("#"+a).dialog({autoOpen:!0,modal:!0}),h.removeClass("is-active")})},c.init()}(wp.customize,jQuery);
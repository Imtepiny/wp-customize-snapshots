!function(a,b){"use strict";var c;a.Snapshots||(a.Snapshots={}),c=a.Snapshots,c.data={},"undefined"!=typeof _customizeSnapshots&&_.extend(c.data,_customizeSnapshots),c.init=function(){window._wpCustomizeControlsL10n.save=c.data.i18n.publish,window._wpCustomizeControlsL10n.saved=c.data.i18n.published,a.bind("ready",function(){!a.settings.theme.active||c.data.theme&&c.data.theme!==a.settings.theme.stylesheet||(c.previewerQuery(),c.addButton(),b("#snapshot-save").on("click",function(a){a.preventDefault(),c.sendUpdateSnapshotRequest(a)}),c.data.isPreview&&(a.state("saved").set(!1),c.resetSavedStateQuietly()))}),a.bind("save",function(a){return a.fail(function(a){var d="snapshot-dialog-error",e=wp.template(d);a.responseText&&(0===b("#"+d).length&&b("body").append(e({title:c.data.i18n.publish,message:c.data.i18n.permsMsg})),b("#customize-header-actions .spinner").removeClass("is-active"),b("#"+d).dialog({autoOpen:!0,modal:!0}))}),a})},c.previewerQuery=function(){var b=a.previewer.query;a.previewer.query=function(){var d,e={};return d=b.apply(this,arguments),c.data.isPreview&&(a.each(function(a,b){e[b]={value:a(),dirty:!1}}),d.snapshot_customized=JSON.stringify(e),d.snapshot_uuid=c.data.uuid),d}},c.addButton=function(){var a,d,e=b("#customize-header-actions"),f=e.find("#save");e.length&&0===e.find("#snapshot-save").length&&(a=wp.template("snapshot-save"),d={buttonText:c.data.isPreview?c.data.i18n.updateButton:c.data.i18n.saveButton},a=b(b.trim(a(d))),c.data.currentUserCanPublish||(a.attr("title",c.data.i18n.permsMsg),a.addClass("button-primary").removeClass("button-secondary")),a.insertAfter(f)),c.data.currentUserCanPublish||f.hide(),e.addClass("button-added")},c.resetSavedStateQuietly=function(){a.state("saved")._value=!0},c.sendUpdateSnapshotRequest=function(d){var e,f,g=b("#customize-header-actions .spinner"),h=c.data.scope;g.addClass("is-active"),f={},a.each(function(a,b){f[b]={value:a(),dirty:a._dirty}}),e=wp.ajax.post("customize_update_snapshot",{nonce:c.data.nonce,wp_customize:"on",snapshot_customized:JSON.stringify(f),customize_snapshot_uuid:c.data.uuid,scope:h,preview:c.data.isPreview?"on":"off"}),e.done(function(e){var f=a.previewer.previewUrl(),i=new RegExp("([?&])customize_snapshot_uuid=.*?(&|$)","i"),j=-1!==f.indexOf("?")?"&":"?",k=b("#customize-header-actions"),l=a.previewer.targetWindow.get().location.toString(),m=-1!==l.indexOf("?")?"&":"?";c.data.uuid||(c.data.uuid=e.customize_snapshot_uuid),f=f.match(i)?f.replace(i,"$1customize_snapshot_uuid="+encodeURIComponent(c.data.uuid)+"$2"):f+j+"customize_snapshot_uuid="+encodeURIComponent(c.data.uuid),"full"===h&&(f+="&scope="+encodeURIComponent(h)),k.length&&0!==k.find("#snapshot-save").length&&k.find("#snapshot-save").text(c.data.i18n.updateButton),g.removeClass("is-active"),c.resetSavedStateQuietly(),history.replaceState&&!l.match(i)&&(l+=m+"customize_snapshot_uuid="+encodeURIComponent(c.data.uuid),"full"===h&&(l+="&scope="+encodeURIComponent(h)),history.replaceState({},document.title,l)),d.shiftKey&&window.open(f,"_blank"),a.trigger("customize-snapshots-update",{previewUrl:f,customizeUrl:l,uuid:c.data.uuid})}),e.fail(function(){var a="snapshot-dialog-error",d=wp.template(a);0===b("#"+a).length&&b("body").append(d({title:c.data.i18n.errorTitle,message:c.data.i18n.errorMsg})),b("#"+a).dialog({autoOpen:!0,modal:!0}),g.removeClass("is-active")})},c.init()}(wp.customize,jQuery);